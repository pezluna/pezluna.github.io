---
layout: forensic
url: forensic
title: "파일 시스템 구조 (3)"
---

# FAT32 실습
앞서 작성한 두 포스팅은 글로만 적혀있어 가독성이 충분히 높지 않고, 약간 장황하며 추상적이었기에 이렇게 실습 포스팅도 필요하다고 생각되어 작성한다.  
가지고 있는 4GB USB 하나를 가지고서, FAT32의 파일 시스템 구조를 분석하고자 한다. FAT16과의 차이점을 짚어나가며 하나씩 전부 살펴보고, 이를 분석하기 위해서이다.  
해당 USB는 FTK를 이용하여 이미지화 시켰으며, HxD를 통해 분석을 진행하였다.  

# MBR
이미지 파일을 열자 바로 보이는 것이 MBR이다. MBR의 구조는 아래와 같다.  

![MBR](/assets/images/FAT32_0001.jpg)

MBR의 마지막을 알리는 시그니처가 붉은 사각형으로 체크되어있다. 시그니처의 바로 앞의 파란 사각형은 해당 디스크의 파티션을 나타내는 곳으로, 1번 파티션만 등록되어있음을 확인할 수 있다.  
파티션의 정보를 하나하나 살펴보자.  

* 첫 바이트가 0x80이므로 부팅이 가능한 파티션이라는 뜻이다.
* 0x000101은 CHS 시작 주소이다.
* 0x0C는 FAT32를 의미한다.
* 0xEB7FFE는 CHS 끝 주소이다.
* 0x0000003F는 LBA 시작 주소이다.
* 0x0078BFC1은 파티션 섹터의 개수이다.

이를 통해 해당 파티션의 정보는 0x0000003F, 즉 63번째 섹터부터 기록되어있을 것이라 추측할 수 있다.

# FAT32 파티션

![Partition](/assets/images/FAT32_0002.jpg)

63번째 섹터의 이미지이다. 해당 섹터의 마지막에 시그니처가 들어있으므로, 부트섹터와 VBR이 동일함을 알 수 있다. 첫 3바이트 및 8바이트는 분석에 큰 영향을 주지 않기에 무시해도 좋을 것이다.  
노란 사각형이 파티션의 설정을 담고있는 BPB영역이다. FAT32와 FAT16의 차이점을 여기서 확인할 수 있는데, FAT32의 BPB영역이 FAT16에서보다 더욱 길다. 파티션 테이블과 마찬가지로 하나씩 살펴보도록 하자.  

* 첫 2바이트는 섹터의 크기를 나타낸다. 따라서 0x0200바이트인 512바이트가 1섹터이다.
* 그 뒤 1바이트는 클러스터의 크기를 나타낸다. 0x08섹터이므로 4096바이트가 1클러스터이다.
* 다음 2바이트는 FAT 영역 앞의 예약된 영역이 몇 섹터가 있는지를 나타낸다. 0x03C0이므로, 960개의 섹터가 예약된 영역임을 알 수 있다.
* 그 다음의 1바이트는 FAT 영역의 개수를 의미하는데, 일반적으로 2개로 설정되어있다.
* 그 뒤의 0x0000은 FAT32의 특징으로, 원래라면 루트 디렉토리의 엔트리 개수가 들어가야하는 곳이다. 그러나 FAT32에서는 해당 필드는 항상 0으로 세팅되어있다.
* 그 뒤 0x0000은 볼륨 상의 섹터수를 의미한다. 0으로 초기화되어있는 이유는 2바이트만으로 표현할 수 없다는 것을 의미한다.
* 0xF8은 미디어 타입을 나타내는데, 플로피디스크를 제외하고 모두 0xF8로 초기화되어있다.
* 그 뒤의 0x0000또한 FAT32에서는 항상 0으로 초기화되는 필드이다.
* 다음 2바이트는 트랙당 섹터수로, 0x003F임을 확인할 수 있다.
* 헤더의 개수는 0x00FF이다.
* 볼륨앞 히든 섹터의 개수는 0x0000003F이다.
* 이 뒤의 4바이트인 0x0078BFC1이 볼륨상의 총 섹터수를 나타내는 값으로, 앞서 말했듯 2바이트로 표현할 수 없었기에 여기에 작성되어있다.

여기까지의 필드는 FAT16과 동일한 구조로, 이 다음의 필드들이 FAT32로 들어섬에 따라 새로 추가된 필드들이다. 해당 필드들의 설명은 필요하면 추가로 작성하도록 하겠다.  

# FSINFO
FAT32에는 FSINFO(File System INFO)라는 구조체가 있는데, 부트섹터의 바로 다음에 위치해있다.

![FSINFO](/assets/images/FAT32_0003.jpg)

해당 구조체는 1섹터 크기만큼을 차지하나, 대부분이 0x00으로 채워져있다는게 가장 큰 특징이다. 붉은 사각형으로 칠해진 필드는 시그니처이며, 실상 확인해야하는 부분은 초록색과 파란색 사각형뿐이다. 시그니처는 RRaA와 rrAa이므로 쉽게 찾을 수 있다.  
초록색 사각형은 사용할 수 있는 클러스터의 개수를 의미하며, 파란색 사각형은 사용할 수 있는 클러스터의 위치를 의미한다. 해당 구조체를 통해, 우리는 0x000F0EEE만큼의 클러스터를 사용할 수 있으며, 0x0000010C번째 클러스터부터 사용할 수 있다는 뜻이 된다.  
이 때, 클러스터의 개수를 살펴보자. 0x000F0EEE는 10진수로 986862인데, 이 말은 986862개의 클러스터만큼의 용량이 할당되어있다는 말이다. 1클러스터가 4096바이트였으므로, 결과적으로 해당 파티션은 4042186752바이트라는 말이 된다.

![USB_STORAGE](/assets/images/FAT32_0004.jpg)

위와 같이, 해당 USB의 사용가능한 용량과 동일함을 알 수 있다.  

# 추가적인 예약 영역
위의 BPB에서 살펴봤듯, 예약된 영역의 크기는 무려 960개의 섹터이다. 나머지 영역은 모두 예약된 영역이 혹시 많은 공간을 차지할까봐 미리 할당을 해둔 공간이라고 생각해두면 된다.  
VBR의 백업은 VBR 섹터로부터 6섹터 후에 존재한다.
